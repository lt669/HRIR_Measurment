%%
%clear all; 
%clc; 

r = 0.075;  % Array radius
c = 343;    % Speed of sound
Fs = 44100; % Sample rate
Fstep = 10; % Frequency stepsize

% Generated from AFormatFilters.m and invfreqz()
% aW = [1,27.6326764801779,155.485950891545,102.176189372558,-988.966146671945,-1829.78288552771,765.570262139083,3780.99997346309,2202.45214419739,-405.647367379323,-1249.54648658348,-2040.55572809890,-2016.76752847341,-656.134012856238,-76.7425108615659,-1164.83326713761,-591.992883564592,1238.68353500154,1605.30475445111,673.815887191760,-501.537687658361,1207.21268484641,1484.48070510655,-895.009110054052,573.459803869228,650.496576036253,-167.360423974276,1448.94598567000,150.787283570110,-697.898755987574,-2628.86879927700,-3770.96852403398,-147.595113871907,1928.71509700837,2603.31454701594,622.497825415358,-572.535231129018,1190.41015511017,-198.333761039118,-3113.28998845576,-602.197550453825,2474.15929008111,-598.673671946025,-251.582697402053,526.926750244753,-1693.20687106217,-699.503284710895,454.698422784995,775.527841690748,318.166492473418,1264.52017624565,2264.86073604795,-155.798415507621,-2161.85307351232,-1749.79445013193,74.0008598254977,741.983117405575,-51.1341565612068,101.129055367404,413.774310279355,46.6665157361433,-133.973389580425,-52.1450507908277,-5.18261132124794,-0.0553950405917013];
% bW = [43.4480005417939,648.011027912291,1555.61011637893,-4437.51236757519,-14870.5629471166,5397.23317779682,38108.1296054975,8757.96682918845,-29304.9660580195,-13795.2596225073,-5880.53810083470,-6687.77017550265,7599.31992592388,13160.7159226330,-6053.27342686132,-8570.83110412723,17058.8202266520,11204.7951409917,-2845.68545499092,-14540.8669890127,905.479141074880,22949.0236707555,-20937.1527881584,-6554.29864667193,21045.3816913459,-16912.4062095715,11563.1682233112,4795.90526529114,-17315.0873008513,-4311.47362002026,-29802.2217139268,17658.2244894617,33067.3031896028,9946.29363705910,-2795.43892815310,-27339.2792676722,10945.1364634215,9362.07664785251,-31885.4063578401,-9015.81823319956,47443.5420898647,-6449.57061416427,-27544.0455907856,24723.9131329460,-18029.3743411781,-8357.81207404292,16877.4249802910,5192.72645880816,-810.396536281694,-2680.52262194471,19096.0553566739,-7523.40676376549,-28287.0636722338,-6836.23832996300,13155.7632654257,16134.3250247509,-4781.55221706718,-5137.91208178600,5548.55257000791,-1161.56404887612,-3699.66860024435,226.763062844193,825.541227858933,154.756724173383,3.94911374467828];
% aXYZ = [1,28.6559384140073,166.715442989276,114.841358789299,-1087.17677695390,-1880.49011388152,1419.42137703420,4112.90541358568,305.920695458697,-2038.10787536442,-285.937363562537,-426.415745305946,-374.081223157051,637.372614502877,917.822976545124,-1504.80575130897,-1475.90832097743,1949.69151547139,-2470.23244088164,-3382.87956217245,769.987603622811,-352.857895717230,1268.06966832220,2047.53183422769,1298.45837078218,173.279104674390,284.303835148566,1128.29848419343,-1002.30211801634,1652.23729458435,2000.00688529149,616.997270252433,749.232749501801,-970.698976270875,-1173.57202554836,-873.826458221182,-1480.30541404222,-3235.22815770567,117.355986334181,386.958590713558,294.812622543133,2156.84184584772,-2428.15459212380,-6.92963506373529,91.4325762249889,-1063.02070403953,2867.05169333382,545.126510285603,923.712005000782,568.023951463321,-1293.44744822873,-442.844157179478,-2534.62109279878,274.474962557628,4035.20310430960,-37.9514257522774,-2623.35778146731,-395.323338077708,814.739698281781,279.988212444943,-80.8208648309446,-51.3998157958745,-3.91447436628412,1.05536645962114,0.0854914770620654];
% bXYZ = [102.769455408225,1542.33399445292,3526.90792390861,-11997.4482047333,-34908.6763967334,29228.1627169025,100364.487469502,-34562.0448787521,-110797.558161462,31044.9704912520,29532.0196872666,-15631.4103754082,20634.2989719060,17985.4831354558,-24832.2522707406,-60583.3550830004,89382.7269234868,-9448.16386818354,-128040.280215626,112167.084659821,14608.9879515017,-21079.0666548984,52031.8337254985,-29038.6971262089,-13757.3893486586,-31472.2338269010,46745.2498165446,-38805.6226042270,2433.08611510737,74448.9731050543,-57166.6353967928,11138.1665495121,-24631.3222571764,-18796.6707631933,12839.5474703733,10916.3663481714,-44688.2825827485,21088.5373870209,81716.4104509877,-65976.4504512731,72725.3443426854,-68491.1045987438,-48301.9030189066,100954.295269902,-90498.9584876981,83058.7658617741,9202.10830941021,-61831.7173850744,47903.5982109006,-66461.5935888308,20344.5582269265,-14978.9723602148,-18439.7273705753,132448.651467207,-30098.0180432795,-119897.414994981,29029.8564079407,57186.3001698639,-5933.58067990151,-16139.3095205560,-1450.03527260607,2046.63234125937,457.279323025659,-35.2861352226225,-8.29136277299697];
%

%% Read A-Format file begin
filename='speechmix'; %A-Format file 
[sig, fs] = audioread([filename '.wav']);
% Read A-Format file end

%% Generate W_, X_, Y_, Z_ begin
% Note the '_' denotes the uncompensated form of the B-Format signals

% The configuration of the 4 Mics of Twirling720 recoding device
% signal -> (azimuth angle (+'ve clockwise), elevation angle)
% sig(:,1) 90º ,  35º Right Up
% sig(:,2) 180º, -35º Back Down
% sig(:,3) 0º  , -35º Front Down
% sig(:,4) 270º,  35º Left Up

% (Using horizontal / anticlockwise ordering of mic capsules - 3, 4, 2, 1)
W_ =   sig(:,3) + sig(:,4) + sig(:,2) + sig(:,1);
X_ =   sqrt(2) * (sig(:,3) - sig(:,2));
Y_ =   sqrt(2) * (sig(:,4) - sig(:,1));
Z_ = - sig(:,3) + sig(:,4) - sig(:,2) + sig(:,1);

% generate W_, X_, Y_, Z_ end

%% compansation filter processing to W1,X1,Y1,Z1 begin

r = 0.075; % Array radius
c = 343; % Speed of sound
Fs = 44100; % Sample rate
Fstep = 10; % Frequency stepsize

i = 1;

nfft = 1024;

for f = 0:Fs/nfft:Fs-(Fs/nfft)
    
    w = 2*pi*f;
    
    % Compute W compensation response

    Num = 1 + (j*w*r)/c - (1/3)*(((w*r)/c)*((w*r)/c));
    Den = 1 + (1/3)*(j*w*r)/c;
    FW(i) = Num/Den;
    
    % Compute XYZ compensation response
    
    Num = sqrt(6)*(1 + (1/3)*(j*w*r)/c - (1/3)*(((w*r)/c)*((w*r)/c)));
    Den = 1 + (1/3)*(j*w*r)/c;
    FXYZ(i) = Num/Den;
        
    i = i+1;
end

FW(1, (nfft/2)+2:nfft) = conj(fliplr(FW(1, 2:nfft/2)));
FW(1, nfft/2+1) = 0;

timeFW = real(ifft(FW));
shiftTimeFW = circshift(timeFW, nfft/2, 2);

W = conv(W_, shiftTimeFW);
X = conv(X_, shiftTimeFW);
Y = conv(Y_, shiftTimeFW);
Z = conv(Z_, shiftTimeFW);

% % compansation filter processing to W1,X1,Y1,Z1 end

%% write B-Format begin

BFormat_ = [W_ / sqrt(2), X_, Y_, Z_];
audiowrite( sprintf('%s_B_Format_.wav',filename),BFormat_, fs);

BFormat = [W / sqrt(2), X, Y, Z];
audiowrite( sprintf('%s_B_Format.wav',filename),BFormat, fs);

n3dHOA = [BFormat(:, 1); BFormat(:, 3); BFormat(:, 4); BFormat(:, 2)];
audiowrite( sprintf('%s_n3dHOA2.wav',filename), n3dHOA', fs);

% write W1,X1,Y1,Z1 separately end 